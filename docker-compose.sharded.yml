version: '3.8'

services:
  # ==================== CONFIG SERVER ====================
  # Config server l∆∞u metadata v·ªÅ sharding
  mongo-config:
    image: mongo:6.0
    container_name: mongo-config-server
    restart: unless-stopped
    command: mongod --configsvr --replSet configReplSet --port 27019 --bind_ip_all
    ports:
      - "27019:27019"
      - "${MY_TAILSCALE_IP}:27019:27019"
    volumes:
      - mongo_config_data:/data/configdb
    networks:
      - rental-network
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27019", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s

  # ==================== CONFIG INIT (QUAN TR·ªåNG!) ====================
  config-init:
    image: mongo:6.0
    container_name: mongo-config-init
    depends_on:
      mongo-config:
        condition: service_healthy
    volumes:
      - ./init-sharding:/scripts
    entrypoint: []
    command: >
      bash -c "
        echo '‚è≥ Waiting 15 seconds for config server to stabilize...';
        sleep 15;
        
        echo 'üîß Initializing config server replica set...';
        mongosh --host mongo-config:27019 --file /scripts/init-config.js;
        
        if [ $$? -eq 0 ]; then
          echo '‚úÖ Config server initialized successfully';
          exit 0;
        else
          echo '‚ùå Config server initialization failed';
          exit 1;
        fi;
      "
    networks:
      - rental-network
    restart: "no"

  # ==================== SHARD INIT ====================
  shards-init:
    image: mongo:6.0
    container_name: mongo-shards-init
    depends_on:
      config-init:
        condition: service_completed_successfully
      mongo-shard1:
        condition: service_healthy
      mongo-shard2:
        condition: service_healthy
      mongo-shard3:
        condition: service_healthy
      mongo-shard4:
        condition: service_healthy
    volumes:
      - ./init-sharding:/scripts
    entrypoint: []
    command: >
      bash -c "
        echo '‚è≥ Waiting 10 seconds for shards to stabilize...';
        sleep 10;
        
        echo 'üîß Initializing all shard replica sets...';
        mongosh --host mongo-shard1:27021 --file /scripts/init-shards.js;
        
        if [ $$? -eq 0 ]; then
          echo '‚úÖ All shards initialized successfully';
          exit 0;
        else
          echo '‚ùå Shards initialization failed';
          exit 1;
        fi;
      "
    networks:
      - rental-network
    restart: "no"

  # ==================== SHARDS ====================
  # ==================== SHARD 1: USERS ====================
  # Functional Sharding: User data
  # Hash Sharding: Distributed by _id
  mongo-shard1:
    image: mongo:6.0
    container_name: mongo-shard1-users
    restart: unless-stopped
    command: mongod --shardsvr --replSet shard1ReplSet --port 27021 --bind_ip_all
    ports:
      - "27021:27021"
      - "${MY_TAILSCALE_IP}:27021:27021"
    volumes:
      - mongo_shard1_data:/data/db
    networks:
      - rental-network
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27021", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s

  # ==================== SHARD 2: VEHICLES ====================
  # Functional Sharding: Vehicle data (ALL locations)
  # Hash Sharding: Distributed by vehicle_id
  mongo-shard2:
    image: mongo:6.0
    container_name: mongo-shard2-vehicles
    restart: unless-stopped
    command: mongod --shardsvr --replSet shard2ReplSet --port 27022 --bind_ip_all
    ports:
      - "27022:27022"
      - "${MY_TAILSCALE_IP}:27022:27022"
    volumes:
      - mongo_shard2_data:/data/db
    networks:
      - rental-network
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27022", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s

  # ==================== SHARD 3: BOOKINGS ====================
  # Functional Sharding: Booking data
  # Hash Sharding: Distributed by user_id
  mongo-shard3:
    image: mongo:6.0
    container_name: mongo-shard3-bookings
    restart: unless-stopped
    command: mongod --shardsvr --replSet shard3ReplSet --port 27023 --bind_ip_all
    ports:
      - "27023:27023"
      - "${MY_TAILSCALE_IP}:27023:27023"
    volumes:
      - mongo_shard3_data:/data/db
    networks:
      - rental-network
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27023", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s

  # ==================== SHARD 4: PAYMENTS ====================
  # Functional Sharding: Payment data
  # Hash Sharding: Distributed by payment_id
  mongo-shard4:
    image: mongo:6.0
    container_name: mongo-shard4-payments
    restart: unless-stopped
    command: mongod --shardsvr --replSet shard4ReplSet --port 27024 --bind_ip_all
    ports:
      - "27024:27024"
      - "${MY_TAILSCALE_IP}:27024:27024"
    volumes:
      - mongo_shard4_data:/data/db
    networks:
      - rental-network
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27024", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s

  # ==================== MONGOS ROUTER ====================
  # Router ph√¢n ph·ªëi queries ƒë·∫øn ƒë√∫ng shard
  mongos:
    image: mongo:6.0
    container_name: mongos-router
    restart: unless-stopped
    command: mongos --configdb configReplSet/mongo-config:27019 --port 27017 --bind_ip_all
    ports:
      - "27017:27017"
      - "${MY_TAILSCALE_IP}:27017:27017"
    depends_on:
      shards-init:
        condition: service_completed_successfully
    networks:
      - rental-network
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27017", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 90s

  # ==================== CLUSTER INIT ====================
  cluster-init:
    image: mongo:6.0
    container_name: mongo-cluster-init
    depends_on:
      mongos:
        condition: service_healthy
    volumes:
      - ./init-sharding:/scripts
    entrypoint: []
    command: >
      bash -c "
        echo '‚è≥ Waiting 20 seconds for mongos to fully initialize...';
        sleep 20;
        
        echo 'üöÄ Adding shards to cluster and configuring sharding...';
        mongosh --host mongos:27017 --file /scripts/add-shards.js;
        
        if [ $$? -eq 0 ]; then
          echo '';
          echo '‚úÖ Sharding configuration completed!';
          echo '';
          echo 'üîß Creating indexes...';
          mongosh --host mongos:27017 --file /scripts/setup-indexes.js;
          
          echo '';
          echo 'üìä Final Cluster Status:';
          mongosh --host mongos:27017 --quiet --eval 'sh.status()';
          
          echo '';
          echo '‚úÖ All initialization completed successfully!';
          exit 0;
        else
          echo '‚ùå Cluster initialization failed';
          exit 1;
        fi;
      "
    networks:
      - rental-network
    restart: "no"

  # ==================== USER SERVICE ====================
  user_service:
    build:
      context: ./user_service
      dockerfile: Dockerfile
    container_name: rental-user-service
    restart: unless-stopped
    ports:
      - "8001:8001"
      - "${MY_TAILSCALE_IP}:8001:8001"
    environment:
      - MONGO_URL=mongodb://mongos:27017
      - MONGO_DB=rental_db
      - SECRET_KEY=${SECRET_KEY}
      - ALGORITHM=${ALGORITHM}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES}
    depends_on:
      cluster-init:
        condition: service_completed_successfully
    networks:
      - rental-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================== API GATEWAY ====================
  api_gateway:
    build:
      context: ./api_gateway
      dockerfile: Dockerfile
    container_name: rental-api-gateway
    restart: unless-stopped
    ports:
      - "8000:8000"
      - "${MY_TAILSCALE_IP}:8000:8000"
    environment:
      - GATEWAY_HOST=0.0.0.0
      - GATEWAY_PORT=8000
      - USER_SERVICE_URL=http://user_service:8001
      - VEHICLE_SERVICE_URL=${VEHICLE_SERVICE_URL}
      - BOOKING_SERVICE_URL=${BOOKING_SERVICE_URL}
      - PAYMENT_SERVICE_URL=${PAYMENT_SERVICE_URL}
    depends_on:
      user_service:
        condition: service_healthy
    networks:
      - rental-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  mongo_config_data:
  mongo_shard1_data:
  mongo_shard2_data:
  mongo_shard3_data:
  mongo_shard4_data:

networks:
  rental-network:
    driver: bridge