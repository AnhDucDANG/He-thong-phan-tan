# Docker Compose cho Vehicle Service (Đức)
# Kết nối đến MongoDB Sharded Cluster của Lâm qua Tailscale

version: '3.8'

services:
  # ==================== VEHICLE SERVICE ====================
  vehicle_service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rental-vehicle-service
    restart: unless-stopped
    
    # Mở port ra ngoài và cho Tailscale
    ports:
      - "8002:8002"
      - "100.73.22.88:8002:8002"  # Tailscale IP của Đức
    
    # Biến môi trường kết nối
    environment:
      # Kết nối đến MongoDB của Lâm qua Tailscale
      - MONGO_URI=mongodb://100.69.63.99:27017/rental_db
      - PORT=8002
      
      # Tailscale IP của máy Đức
      - MY_TAILSCALE_IP=100.73.22.88
      
      # External Services (qua Tailscale)
      - USER_SERVICE_URL=http://100.69.63.99:8001
      - VEHICLE_SERVICE_URL=http://100.73.22.88:8002
      - BOOKING_SERVICE_URL=http://100.65.117.32:8003
      - PAYMENT_SERVICE_URL=http://100.108.163.69:8004
    
    # Sử dụng network mode host để kết nối Tailscale dễ dàng hơn
    network_mode: host
    
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8002/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

# ==================== LƯU Ý ====================
# 1. Không cần MongoDB container riêng nữa
# 2. Kết nối trực tiếp đến MongoDB của Lâm qua Tailscale (100.69.63.99:27017)
# 3. Đảm bảo Tailscale đã đăng nhập và kết nối
# 4. Database chung: rental_db
# 5. Collection: vehicles (trong shard 2)